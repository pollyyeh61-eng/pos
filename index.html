<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUXE POS | å°ˆæ¥­å¥¢è¯ç®¡ç†ç«¯</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-black: #0a0a0a;
            --gold-bright: #d4af37;
            --gold-dark: #8c6d1f;
            --text-gold: #f3e5ab;
            --card-bg: #151515;
            --danger: #802020;
        }

        body { background-color: var(--bg-black); color: var(--text-gold); font-family: 'PingFang TC', sans-serif; margin: 0; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 450px; padding: 25px; box-sizing: border-box; border: 1px solid var(--gold-dark); min-height: 100vh; background: linear-gradient(145deg, #111, #050505); }
        h1 { text-align: center; letter-spacing: 5px; color: var(--gold-bright); font-size: 24px; margin-bottom: 25px; }

        .tabs { display: flex; gap: 5px; margin-bottom: 25px; }
        .tab-button { flex: 1; background: transparent; border: 1px solid var(--gold-dark); color: var(--gold-dark); padding: 12px 2px; cursor: pointer; border-radius: 4px; font-size: 13px; transition: 0.3s; }
        .tab-button.active { background: var(--gold-dark); color: #000; font-weight: bold; }

        label { font-size: 12px; color: var(--gold-bright); margin-bottom: 8px; display: block; opacity: 0.8; }
        input, select { width: 100%; padding: 15px; margin-bottom: 20px; background: var(--card-bg); border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box; }

        .btn-luxe { width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; letter-spacing: 3px; color: #000; background: linear-gradient(45deg, var(--gold-dark), var(--gold-bright)); }
        .btn-outline { background: transparent; border: 1px solid var(--gold-dark); color: var(--text-gold); padding: 10px; border-radius: 8px; cursor: pointer; font-size: 12px; width: 100%; margin-bottom: 15px; }

        .report-card { background: rgba(212, 175, 55, 0.05); border: 1px solid var(--gold-dark); padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .report-stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .report-total { font-size: 28px; color: var(--gold-bright); font-weight: 900; text-align: center; margin: 10px 0; }
        
        .detail-header { font-size: 11px; color: var(--gold-bright); border-bottom: 1px solid var(--gold-dark); padding-bottom: 5px; margin-top: 15px; display: flex; justify-content: space-between; }
        .detail-list { max-height: 250px; overflow-y: auto; margin-top: 10px; }
        .detail-item { display: flex; justify-content: space-between; font-size: 11px; padding: 10px 0; border-bottom: 1px solid #222; align-items: center; }
        
        #memberBrief { background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .result-box { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--gold-bright); display:none; }
        .type-tag { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .tag-member { background: var(--gold-dark); color: #000; }
        .tag-guest { border: 1px solid #666; color: #999; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘‘ LUXE POS</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'sale')">æ”¶éŠ€æ‰£æ¬¾</button>
        <button class="tab-button" onclick="openTab(event, 'staff_query')">æ¥­ç¸¾æ˜ç´°</button>
        <button class="tab-button" onclick="openTab(event, 'reports'); fetchPeriodicReport('day');">åº—å‹™æ—¥å ±</button>
    </div>

    <div id="sale" class="tab-content">
        <div id="step1">
            <label>è¾¨è­˜è²´è³“æ‰‹æ©Ÿ</label>
            <input type="tel" id="customer_phone" placeholder="09xxxxxxxx" oninput="checkMemberQuickly()">
            <button class="btn-outline" style="border-style: dashed;" onclick="setGuestMode()">ğŸ‘¤ ä¸€èˆ¬æ•£å®¢çµå¸³</button>
            <div id="memberBrief" style="display:none;">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--gold-bright);" id="briefName">---</div>
                <div style="margin-top: 8px;">å¯ç”¨é¤˜é¡ï¼š<span id="briefBalance" style="color:var(--gold-bright); font-weight:bold;">$0</span></div>
            </div>
            <button class="btn-luxe" id="btnNext" onclick="goToStep(2)" style="display:none;">é€²å…¥çµå¸³ä»‹é¢</button>
        </div>

        <div id="step2" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                <span>å°è±¡ï¼š<b id="finalName"></b> <span id="finalType"></span></span>
                <u style="cursor:pointer; font-size:12px; color:var(--gold-dark);" onclick="goToStep(1)">é‡æ–°é¸å–</u>
            </div>
            
            <label>è² è²¬è¨­è¨ˆå¸«</label>
            <input type="text" id="staff" placeholder="è¼¸å…¥å§“å">
            
            <label>ğŸ’‡â€â™‚ï¸ æŠ€è¡“æœå‹™æ”¶å…¥ (å‰ª/æŸ“/ç‡™/è­·)</label>
            <input type="number" id="tech_amount" placeholder="0" oninput="sumTotal()">
            
            <label>ğŸ§´ ç”¢å“è²©å”®æ”¶å…¥ (æ´—è­·ç”¢å“)</label>
            <input type="number" id="prod_amount" placeholder="0" oninput="sumTotal()">

            <div style="text-align:center; margin:10px 0 20px 0; border-top:1px solid #333; padding-top:10px;">
                <span style="font-size:14px; opacity:0.8;">ç¸½ä»˜æ¬¾é‡‘é¡ï¼š</span>
                <span style="font-size:24px; color:var(--gold-bright); font-weight:bold;">$<span id="total_display">0</span></span>
            </div>

            <label>æ”¯ä»˜æ–¹å¼</label>
            <select id="payment">
                <option value="å„²å€¼é‡‘">â­ å„²å€¼é‡‘æ‰£æ¬¾</option>
                <option value="ç¾é‡‘">ğŸ’µ ç¾é‡‘çµå¸³</option>
                <option value="ä¿¡ç”¨å¡">ğŸ’³ ä¿¡ç”¨å¡/è¡Œå‹•æ”¯ä»˜</option>
            </select>

            <button class="btn-luxe" onclick="submitSale()">åŸ·è¡Œäº¤æ˜“ä¸¦å­˜æª”</button>
        </div>
        <div id="saleResult" class="result-box"></div>
    </div>

    <div id="staff_query" class="tab-content" style="display:none;">
        <label>æŸ¥è©¢è¨­è¨ˆå¸«å§“å</label>
        <input type="text" id="q-staff" placeholder="è¼¸å…¥åç¨±">
        <button class="btn-luxe" onclick="fetchStaffReport()">ç”Ÿæˆæ˜ç´°å ±è¡¨</button>
        <div id="staffResult" style="margin-top:20px;"></div>
    </div>

    <div id="reports" class="tab-content" style="display:none;">
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <button class="tab-button" id="btnDay" onclick="fetchPeriodicReport('day')">æœ¬æ—¥</button>
            <button class="tab-button" id="btnMonth" onclick="fetchPeriodicReport('month')">æœ¬æœˆ</button>
        </div>
        <div class="report-card">
            <div id="reportTitle" style="color:var(--gold-bright); font-weight:bold;">å…¨åº—ç‡Ÿæ”¶çµ±è¨ˆ</div>
            <div class="report-total" id="repTotal">$0</div>
            <div class="report-stat-row"><span>ğŸ’‡â€â™‚ï¸ æŠ€è¡“ç¸½æ”¶å…¥</span><span id="repTechTotal">$0</span></div>
            <div class="report-stat-row"><span>ğŸ§´ ç”¢å“ç¸½è²©å”®</span><span id="repProdTotal">$0</span></div>
            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
            <label>è¨­è¨ˆå¸«æ’è¡Œ (ç¸½æ¥­ç¸¾)</label>
            <div id="repStaffRank"></div>
        </div>
    </div>
</div>

<script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
        apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
        authDomain: "holyhairsalon-f73bf.firebaseapp.com",
        databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
        projectId: "holyhairsalon-f73bf",
        storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
        messagingSenderId: "960169055224",
        appId: "1:960169055224:web:2a5dafd9bf2f1230bf3c0d"
    };
    firebase.initializeApp(firebaseConfig);
    const rdb = firebase.database();

    let currentMember = null;

    function openTab(evt, tabName) {
        let contents = document.getElementsByClassName("tab-content");
        for (let c of contents) c.style.display = "none";
        let buttons = document.getElementsByClassName("tab-button");
        for (let b of buttons) b.classList.remove("active");
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.classList.add("active");
    }

    function goToStep(step) {
        document.getElementById('step1').style.display = (step === 1) ? 'block' : 'none';
        document.getElementById('step2').style.display = (step === 2) ? 'block' : 'none';
        document.getElementById('saleResult').style.display = 'none';
    }

    function sumTotal() {
        const t = Number(document.getElementById('tech_amount').value || 0);
        const p = Number(document.getElementById('prod_amount').value || 0);
        document.getElementById('total_display').innerText = t + p;
    }

    async function checkMemberQuickly() {
        const phone = document.getElementById('customer_phone').value.trim();
        if (phone.length >= 10) {
            const snapshot = await rdb.ref('members').orderByChild('phone').equalTo(phone).once('value');
            if (snapshot.exists()) {
                const id = Object.keys(snapshot.val())[0];
                currentMember = { id, ...snapshot.val()[id], isGuest: false };
                document.getElementById('briefName').innerText = currentMember.name;
                document.getElementById('briefBalance').innerText = "$" + (currentMember.balance || 0);
                document.getElementById('finalName').innerText = currentMember.name;
                document.getElementById('finalType').innerHTML = '<span class="type-tag tag-member">VIP æœƒå“¡</span>';
                document.getElementById('memberBrief').style.display = 'block';
                document.getElementById('btnNext').style.display = 'block';
            }
        }
    }

    function setGuestMode() {
        currentMember = { id: "GUEST", name: "ä¸€èˆ¬æ•£å®¢", phone: "ç„¡", isGuest: true };
        document.getElementById('finalName').innerText = "ä¸€èˆ¬æ•£å®¢";
        document.getElementById('finalType').innerHTML = '<span class="type-tag tag-guest">æ•£å®¢æ¨¡å¼</span>';
        document.getElementById('payment').value = "ç¾é‡‘";
        goToStep(2);
    }

    async function submitSale() {
        const staff = document.getElementById('staff').value.trim();
        const tech = Number(document.getElementById('tech_amount').value || 0);
        const prod = Number(document.getElementById('prod_amount').value || 0);
        const total = tech + prod;
        const payment = document.getElementById('payment').value;
        const res = document.getElementById('saleResult');

        if (!staff || total <= 0) return alert("è«‹è¼¸å…¥è¨­è¨ˆå¸«åŠæ¶ˆè²»é‡‘é¡");
        res.style.display = 'block';
        res.innerHTML = "ğŸ’ äº¤æ˜“å¯«å…¥ä¸­...";

        try {
            const now = new Date();
            const timeStr = now.toLocaleString('zh-TW', {hour12:false});

            if (!currentMember.isGuest && payment === "å„²å€¼é‡‘") {
                let balance = Number(currentMember.balance || 0);
                if (balance < total) { res.innerHTML = "âŒ é¤˜é¡ä¸è¶³"; return; }
                balance -= total;
                await rdb.ref(`members/${currentMember.id}`).update({ balance: balance });
            }

            // ç¬¦åˆ Rules çš„å¯«å…¥çµæ§‹
            await rdb.ref('pos_sales_log').push({
                customerName: currentMember.name,
                staff: staff,
                tech_income: tech,
                prod_income: prod,
                total_amount: total,
                payment: payment,
                timestamp: Date.now(),
                dateStr: timeStr
            });

            res.innerHTML = `âœ… äº¤æ˜“å®Œæˆï¼<br>${currentMember.name} ç¸½è¨ˆ $${total}`;
            setTimeout(() => location.reload(), 1500);
        } catch (e) { res.innerHTML = "éŒ¯èª¤: " + e.message; }
    }

    // æŸ¥è©¢è¨­è¨ˆå¸«ç´°åˆ†æ˜ç´°
    async function fetchStaffReport() {
        const staffName = document.getElementById('q-staff').value.trim();
        const resultDiv = document.getElementById('staffResult');
        if(!staffName) return alert("è«‹è¼¸å…¥è¨­è¨ˆå¸«å§“å");

        resultDiv.innerHTML = "â³ è®€å–æ˜ç´°ä¸­...";
        try {
            const snapshot = await rdb.ref('pos_sales_log').orderByChild('staff').equalTo(staffName).once('value');
            let tTotal = 0, pTotal = 0, count = 0;
            let listHtml = "";

            snapshot.forEach(c => {
                const d = c.val();
                tTotal += (d.tech_income || 0);
                pTotal += (d.prod_income || 0);
                count++;
                listHtml += `
                    <div class="detail-item">
                        <div style="flex:1">
                            <div style="font-size:9px; opacity:0.6">${d.dateStr.split(' ')[0]}</div>
                            <b>${d.customerName}</b>
                        </div>
                        <div style="flex:1; text-align:right">
                            <span style="color:#aaa">æŠ€:$${d.tech_income}</span> / <span style="color:var(--gold-bright)">å“:$${d.prod_income}</span>
                        </div>
                    </div>`;
            });

            resultDiv.innerHTML = `
                <div class="report-card">
                    <div style="text-align:center; color:var(--gold-bright); font-size:14px;">${staffName} æ¥­ç¸¾åˆ†æ</div>
                    <div class="report-total">$${tTotal + pTotal}</div>
                    <div class="report-stat-row"><span>æŠ€è¡“æ”¶å…¥</span><span>$${tTotal}</span></div>
                    <div class="report-stat-row"><span>ç”¢å“éŠ·å”®</span><span>$${pTotal}</span></div>
                    <div class="detail-header"><span>æ—¥æœŸ / å®¢æˆ¶</span><span>æŠ€è¡“ / ç”¢å“é‡‘é¡</span></div>
                    <div class="detail-list">${listHtml || 'ç„¡æ˜ç´°'}</div>
                </div>`;
        } catch (e) { resultDiv.innerHTML = "æŸ¥è©¢å¤±æ•—: " + e.message; }
    }

    // é€±æœŸå ±è¡¨ (æ—¥å ±/æœˆå ±)
    async function fetchPeriodicReport(type) {
        ['btnDay', 'btnMonth'].forEach(id => document.getElementById(id).classList.remove('active'));
        document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');
        
        const snapshot = await rdb.ref('pos_sales_log').once('value');
        const now = new Date();
        let techAll = 0, prodAll = 0, staffMap = {};

        snapshot.forEach(c => {
            const d = c.val();
            const t = new Date(d.timestamp);
            let match = false;
            if (type === 'day' && t.toDateString() === now.toDateString()) match = true;
            if (type === 'month' && t.getMonth() === now.getMonth()) match = true;
            
            if (match) {
                techAll += (d.tech_income || 0);
                prodAll += (d.prod_income || 0);
                staffMap[d.staff] = (staffMap[d.staff] || 0) + (d.total_amount || 0);
            }
        });

        document.getElementById('repTotal').innerText = "$" + (techAll + prodAll);
        document.getElementById('repTechTotal').innerText = "$" + techAll;
        document.getElementById('repProdTotal').innerText = "$" + prodAll;
        
        let sStr = ""; 
        Object.entries(staffMap).sort((a,b)=>b[1]-a[1]).forEach(([n, v], i) => {
            sStr += `<div class="report-stat-row"><span>${i+1}. ${n}</span><span>$${v}</span></div>`;
        });
        document.getElementById('repStaffRank').innerHTML = sStr || "å°šç„¡æ•¸æ“š";
    }
</script>
</body>
</html>
