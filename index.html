<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LUXE POS | å°ˆæ¥­å¥¢è¯ç®¡ç†ç«¯</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --bg-black: #0a0a0a;
            --gold-bright: #d4af37;
            --gold-dark: #8c6d1f;
            --text-gold: #f3e5ab;
            --card-bg: #151515;
        }

        body {
            background-color: var(--bg-black);
            color: var(--text-gold);
            font-family: 'PingFang TC', sans-serif;
            margin: 0; display: flex; justify-content: center;
        }

        .container {
            width: 100%; max-width: 450px; padding: 25px; box-sizing: border-box;
            border: 1px solid var(--gold-dark); min-height: 100vh;
            background: linear-gradient(145deg, #111, #050505);
        }

        h1 { text-align: center; letter-spacing: 5px; color: var(--gold-bright); font-size: 24px; margin-bottom: 25px; }

        /* ä¸‰é æ¨™ç±¤å°èˆª */
        .tabs { display: flex; gap: 5px; margin-bottom: 25px; }
        .tab-button {
            flex: 1; background: transparent; border: 1px solid var(--gold-dark);
            color: var(--gold-dark); padding: 12px 2px; cursor: pointer; border-radius: 4px;
            font-size: 13px; transition: 0.3s;
        }
        .tab-button.active { background: var(--gold-dark); color: #000; font-weight: bold; }

        label { font-size: 12px; color: var(--gold-bright); margin-bottom: 8px; display: block; opacity: 0.8; }
        input, select {
            width: 100%; padding: 15px; margin-bottom: 20px; background: var(--card-bg);
            border: 1px solid #333; color: #fff; border-radius: 8px; box-sizing: border-box;
        }

        .btn-luxe {
            width: 100%; padding: 16px; border: none; border-radius: 8px; font-weight: bold;
            font-size: 16px; cursor: pointer; letter-spacing: 3px; color: #000;
            background: linear-gradient(45deg, var(--gold-dark), var(--gold-bright));
        }

        /* å ±è¡¨å°ˆç”¨æ¨£å¼ */
        .report-card {
            background: rgba(212, 175, 55, 0.05); border: 1px solid var(--gold-dark);
            padding: 20px; border-radius: 12px; margin-bottom: 20px;
        }
        .report-stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 15px; }
        .report-total { font-size: 24px; color: var(--gold-bright); font-weight: 900; text-align: center; margin: 15px 0; }
        
        .rank-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #222; font-size: 14px; }
        
        #memberBrief { background: rgba(212, 175, 55, 0.1); padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
        .result-box { margin-top: 20px; padding: 15px; border-radius: 8px; text-align: center; border: 1px solid var(--gold-bright); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ‘‘ LUXE POS</h1>

    <div class="tabs">
        <button class="tab-button active" onclick="openTab(event, 'sale')">æ”¶éŠ€æ‰£æ¬¾</button>
        <button class="tab-button" onclick="openTab(event, 'staff_query')">æ¥­ç¸¾æŸ¥è©¢</button>
        <button class="tab-button" onclick="openTab(event, 'reports'); fetchPeriodicReport('day');">é€±æœŸå ±è¡¨</button>
    </div>

    <div id="sale" class="tab-content">
        <div id="step1">
            <label>è­˜åˆ¥æœƒå“¡æ‰‹æ©Ÿ</label>
            <input type="tel" id="customer_phone" placeholder="è¼¸å…¥ 10 ä½æ‰‹æ©Ÿè™Ÿç¢¼" oninput="checkMemberQuickly()">
            <div id="memberBrief" style="display:none;">
                <div style="font-size: 1.2rem; font-weight: bold; color: var(--gold-bright);" id="briefName">---</div>
                <div style="margin-top: 8px;">å¯ç”¨é¤˜é¡ï¼š<span id="briefBalance" style="color:var(--gold-bright); font-weight:bold;">$0</span></div>
            </div>
            <button class="btn-luxe" id="btnNext" onclick="goToStep(2)" style="display:none;">é€²å…¥çµå¸³</button>
        </div>

        <div id="step2" style="display:none;">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span>è²´è³“ï¼š<b id="finalName"></b></span>
                <u style="cursor:pointer; font-size:12px;" onclick="goToStep(1)">é‡é¸</u>
            </div>
            <label>è² è²¬è¨­è¨ˆå¸«</label>
            <input type="text" id="staff" placeholder="è¼¸å…¥åç¨±">
            <label>æ¶ˆè²»ç¸½é¡</label>
            <input type="number" id="amount" placeholder="0">
            <label>æ”¯ä»˜æ¸ é“</label>
            <select id="payment">
                <option value="å„²å€¼é‡‘">â­ å„²å€¼é‡‘æ‰£æ¬¾</option>
                <option value="ç¾é‡‘">ç¾é‡‘çµå¸³</option>
                <option value="ä¿¡ç”¨å¡">ä¿¡ç”¨å¡åˆ·å¡</option>
            </select>
            <button class="btn-luxe" onclick="submitSale()">åŸ·è¡Œäº¤æ˜“</button>
        </div>
        <div id="saleResult" class="result-box" style="display:none;"></div>
    </div>

    <div id="staff_query" class="tab-content" style="display:none;">
        <label>æœå°‹ç‰¹å®šè¨­è¨ˆå¸«æ¥­ç¸¾</label>
        <input type="text" id="q-staff" placeholder="è¼¸å…¥è¨­è¨ˆå¸«å§“å">
        <button class="btn-luxe" style="font-size:14px;" onclick="fetchStaffReport()">æŸ¥è©¢å€‹äººæ•¸æ“š</button>
        <div id="staffResult" style="margin-top:20px;"></div>
    </div>

    <div id="reports" class="tab-content" style="display:none;">
        <div style="display: flex; gap: 8px; margin-bottom: 20px;">
            <button class="tab-button" id="btnDay" onclick="fetchPeriodicReport('day')">æ—¥å ±</button>
            <button class="tab-button" id="btnWeek" onclick="fetchPeriodicReport('week')">é€±å ±</button>
            <button class="tab-button" id="btnMonth" onclick="fetchPeriodicReport('month')">æœˆå ±</button>
        </div>

        <div class="report-card" id="periodicCard">
            <div id="reportTitle" style="color:var(--gold-bright); font-weight:bold; margin-bottom:15px;">æ•¸æ“šè®€å–ä¸­...</div>
            <div class="report-stat-row"><span>äº¤æ˜“ç­†æ•¸</span><span id="repCount">0 ç­†</span></div>
            <div class="report-stat-row"><span>ç¸½ç‡Ÿæ¥­é¡</span></div>
            <div class="report-total" id="repTotal">$0</div>
            <hr style="border:0; border-top:1px solid #333; margin:15px 0;">
            <label>å„æ”¯ä»˜æ–¹å¼ä½”æ¯”</label>
            <div id="repPayments" style="font-size:13px; margin-bottom:15px;"></div>
            <label>è¨­è¨ˆå¸«æ’è¡Œ</label>
            <div id="repStaffRank"></div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCOhBN9TH3UJSOSx5XVyQ08f_2RUckvXYU",
        authDomain: "holyhairsalon-f73bf.firebaseapp.com",
        databaseURL: "https://holyhairsalon-f73bf-default-rtdb.firebaseio.com",
        projectId: "holyhairsalon-f73bf",
        storageBucket: "holyhairsalon-f73bf.firebasestorage.app",
        messagingSenderId: "960169055224",
        appId: "1:960169055224:web:2a5dafd9bf2f1230bf3c0d"
    };

    firebase.initializeApp(firebaseConfig);
    const rdb = firebase.database();

    let currentMember = null;

    function openTab(evt, tabName) {
        let contents = document.getElementsByClassName("tab-content");
        for (let c of contents) c.style.display = "none";
        let buttons = document.getElementsByClassName("tab-button");
        for (let b of buttons) b.classList.remove("active");
        document.getElementById(tabName).style.display = "block";
        if(evt) evt.currentTarget.classList.add("active");
    }

    function goToStep(step) {
        document.getElementById('step1').style.display = (step === 1) ? 'block' : 'none';
        document.getElementById('step2').style.display = (step === 2) ? 'block' : 'none';
    }

    async function checkMemberQuickly() {
        const phone = document.getElementById('customer_phone').value.trim();
        if (phone.length >= 10) {
            const snapshot = await rdb.ref('members').orderByChild('phone').equalTo(phone).once('value');
            if (snapshot.exists()) {
                const id = Object.keys(snapshot.val())[0];
                currentMember = { id, ...snapshot.val()[id] };
                document.getElementById('briefName').innerText = currentMember.name;
                document.getElementById('briefBalance').innerText = "$" + (currentMember.balance || 0);
                document.getElementById('finalName').innerText = currentMember.name;
                document.getElementById('memberBrief').style.display = 'block';
                document.getElementById('btnNext').style.display = 'block';
            } else {
                document.getElementById('memberBrief').style.display = 'none';
                document.getElementById('btnNext').style.display = 'none';
            }
        }
    }

    async function submitSale() {
        const staff = document.getElementById('staff').value.trim();
        const amount = Number(document.getElementById('amount').value);
        const payment = document.getElementById('payment').value;
        const res = document.getElementById('saleResult');

        if (!staff || !amount) return alert("è«‹å®Œæ•´è¼¸å…¥å…§å®¹");
        res.style.display = 'block';
        res.innerHTML = "ğŸ’ è™•ç†ä¸­...";

        try {
            let balance = Number(currentMember.balance || 0);
            if (payment === "å„²å€¼é‡‘") {
                if (balance < amount) { res.innerHTML = "âŒ é¤˜é¡ä¸è¶³"; return; }
                balance -= amount;
            }

            const now = new Date();
            const fullTime = now.toLocaleString('zh-TW', {hour12:false});
            const historyItem = {
                date: fullTime.split(' ')[0], fullTime,
                type: "æ¶ˆè²»", amount,
                note: `[POS] ${staff} (${payment})`, afterBalance: balance
            };

            let history = currentMember.history || [];
            history.unshift(historyItem);

            await rdb.ref(`members/${currentMember.id}`).update({
                balance: balance, history: history.slice(0, 50), lastUpdate: Date.now()
            });

            await rdb.ref('pos_sales_log').push({
                phone: currentMember.phone, customerName: currentMember.name,
                staff, amount, payment, timestamp: Date.now()
            });

            res.innerHTML = `âœ… æ‰£æ¬¾æˆåŠŸï¼<br>å‰©é¤˜é¤˜é¡ï¼š$${balance}`;
            setTimeout(() => {
                location.reload(); // æˆåŠŸå¾Œåˆ·æ–°é‡ç½®
            }, 2500);
        } catch (e) { res.innerHTML = "éŒ¯èª¤: " + e.message; }
    }

    // æ¥­ç¸¾æŸ¥è©¢ (å€‹äºº)
    async function fetchStaffReport() {
        const staffName = document.getElementById('q-staff').value.trim();
        const resultDiv = document.getElementById('staffResult');
        if(!staffName) return alert("è«‹è¼¸å…¥åç¨±");
        
        resultDiv.innerHTML = "æŸ¥è©¢ä¸­...";
        const snapshot = await rdb.ref('pos_sales_log').once('value');
        let total = 0, count = 0;
        
        snapshot.forEach(c => {
            const d = c.val();
            if(d.staff === staffName) { total += d.amount; count++; }
        });

        resultDiv.innerHTML = `
            <div class="report-card">
                <div style="color:var(--gold-bright)">${staffName} çš„æ¥­ç¸¾</div>
                <div class="report-total">$${total}</div>
                <div style="text-align:center">æœå‹™ç¸½äººæ¬¡ï¼š${count} ä½</div>
            </div>`;
    }

    // é€±æœŸå ±è¡¨ (å…¨åº—)
    async function fetchPeriodicReport(type) {
        // åˆ‡æ›æŒ‰éˆ•æ¨£å¼
        ['btnDay', 'btnWeek', 'btnMonth'].forEach(id => document.getElementById(id).classList.remove('active'));
        document.getElementById('btn' + type.charAt(0).toUpperCase() + type.slice(1)).classList.add('active');

        const snapshot = await rdb.ref('pos_sales_log').once('value');
        const now = new Date();
        let total = 0, count = 0;
        let staffMap = {}, payMap = {};

        snapshot.forEach(c => {
            const d = c.val();
            const t = new Date(d.timestamp);
            let match = false;

            if (type === 'day' && t.toDateString() === now.toDateString()) match = true;
            if (type === 'week' && (now - t) < 7*24*60*60*1000) match = true;
            if (type === 'month' && t.getMonth() === now.getMonth() && t.getFullYear() === now.getFullYear()) match = true;

            if (match) {
                total += d.amount;
                count++;
                staffMap[d.staff] = (staffMap[d.staff] || 0) + d.amount;
                payMap[d.payment] = (payMap[d.payment] || 0) + d.amount;
            }
        });

        document.getElementById('reportTitle').innerText = (type==='day'?'ä»Šæ—¥å…¨åº—ç‡Ÿæ”¶':type==='week'?'æœ¬é€±ç´¯è¨ˆç‡Ÿæ”¶':'æœ¬æœˆç´¯è¨ˆç‡Ÿæ”¶');
        document.getElementById('repCount').innerText = count + " ç­†";
        document.getElementById('repTotal').innerText = "$" + total;

        // æ”¯ä»˜ä½”æ¯”
        let payHtml = "";
        for (let p in payMap) payHtml += `<div>${p}: $${payMap[p]}</div>`;
        document.getElementById('repPayments').innerHTML = payHtml || "ç„¡æ•¸æ“š";

        // æ’è¡Œ
        let staffHtml = "";
        Object.entries(staffMap).sort((a,b)=>b[1]-a[1]).forEach(([n, v], i) => {
            staffHtml += `<div class="rank-item"><span>${i+1}. ${n}</span><span>$${v}</span></div>`;
        });
        document.getElementById('repStaffRank').innerHTML = staffHtml || "ç„¡æ•¸æ“š";
    }
</script>
</body>
</html>
